#!/bin/bash
# ========================================
# Git Pre-Commit Hook - Security Partition
# ========================================
# Blocks commits containing sensitive credentials
# Install: cp deployment/git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# ANSI colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Prohibited patterns (Cloud Agent security partition)
PROHIBITED_PATTERNS=(
    "\.env$"
    "\.env\.cloud$"
    "\.env\.local$"
    "\.env\.production$"
    "\.session$"
    "\.session\.json$"
    "credentials\.json$"
    "vault/\.secrets/"
    "odoo_backups/"
    "\.whatsapp_session\.json$"
    "SMTP_PASSWORD="
    "ODOO_PASSWORD="
    "TWITTER_ACCESS_SECRET="
)

# Check staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

BLOCKED=0
echo "üîí Checking for sensitive files..."

for pattern in "${PROHIBITED_PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | grep -E "$pattern" || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}‚ùå BLOCKED: Cannot commit files matching pattern: $pattern${NC}"
        echo -e "${YELLOW}   Matched files:${NC}"
        echo "$MATCHES" | sed 's/^/   - /'
        BLOCKED=1
    fi
done

if [ $BLOCKED -eq 1 ]; then
    echo ""
    echo -e "${RED}üö® COMMIT BLOCKED - Sensitive files detected!${NC}"
    echo -e "${YELLOW}These files are in .gitignore and should NEVER be committed.${NC}"
    echo ""
    echo "To fix:"
    echo "  1. git reset HEAD <file>  # Unstage the file"
    echo "  2. Verify .gitignore includes the pattern"
    echo "  3. For Cloud Agent: NEVER commit SMTP/WhatsApp/Social credentials"
    echo ""
    exit 1
fi

echo "‚úÖ Security check passed - no sensitive files detected"
exit 0
